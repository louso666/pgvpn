*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:DNSPROXY_OUTPUT - [0:0]
:DNSPROXY_PREROUTING - [0:0]
:MANGLE_MARK_ROUTES - [0:0]
-A PREROUTING -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A PREROUTING -m mark --mark 0x1 -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A PREROUTING -m mark --mark 0x2 -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A PREROUTING -m connmark ! --mark 0x0 -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A PREROUTING -j MANGLE_MARK_ROUTES
-A PREROUTING -i wg200 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A PREROUTING -i wg200 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A PREROUTING -s 192.168.1.0/24 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A PREROUTING -s 192.168.1.0/24 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A PREROUTING -s 192.168.2.0/24 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A PREROUTING -s 192.168.2.0/24 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A PREROUTING -j DNSPROXY_PREROUTING
-A FORWARD -i wg200 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
-A FORWARD -o wg200 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
-A FORWARD -o wg-ipsec -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
-A FORWARD -o wg-usa -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
-A OUTPUT -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A OUTPUT -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A OUTPUT -m mark --mark 0x1 -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A OUTPUT -m mark --mark 0x2 -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A OUTPUT -m connmark ! --mark 0x0 -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A OUTPUT -j MANGLE_MARK_ROUTES
-A OUTPUT -j DNSPROXY_OUTPUT
-A POSTROUTING -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A DNSPROXY_OUTPUT -m set --match-set nl_proxy dst -m comment --comment "dnsproxy: NL out" -j MARK --set-xmark 0x1/0xffffffff
-A DNSPROXY_OUTPUT -m set --match-set usa_proxy dst -m comment --comment "dnsproxy: USA out" -j MARK --set-xmark 0x2/0xffffffff
-A DNSPROXY_OUTPUT -m mark ! --mark 0x0 -m comment --comment "dnsproxy: save out" -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A DNSPROXY_PREROUTING -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment "dnsproxy: restore" -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A DNSPROXY_PREROUTING -d 10.10.1.2/32 -m comment --comment "dnsproxy: skip 10.10.1.2" -j RETURN
-A DNSPROXY_PREROUTING -d 10.10.2.2/32 -m comment --comment "dnsproxy: skip 10.10.2.2" -j RETURN
-A DNSPROXY_PREROUTING -d 10.200.0.0/24 -m comment --comment "dnsproxy: skip 10.200.0.0/24" -j RETURN
-A DNSPROXY_PREROUTING -i wg200 -m set --match-set nl_proxy dst -m comment --comment "dnsproxy: NL" -j MARK --set-xmark 0x1/0xffffffff
-A DNSPROXY_PREROUTING -i wg200 -m set --match-set usa_proxy dst -m comment --comment "dnsproxy: USA" -j MARK --set-xmark 0x2/0xffffffff
-A DNSPROXY_PREROUTING -i wg200 -m mark ! --mark 0x0 -m comment --comment "dnsproxy: save" -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A MANGLE_MARK_ROUTES -s 192.168.1.0/24 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A MANGLE_MARK_ROUTES -s 192.168.1.0/24 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A MANGLE_MARK_ROUTES -s 192.168.2.0/24 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A MANGLE_MARK_ROUTES -s 192.168.2.0/24 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A MANGLE_MARK_ROUTES -s 10.200.0.0/24 -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A MANGLE_MARK_ROUTES -s 10.200.0.0/24 -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
-A MANGLE_MARK_ROUTES -m set --match-set nl_proxy dst -j MARK --set-xmark 0x1/0xffffffff
-A MANGLE_MARK_ROUTES -m set --match-set usa_proxy dst -j MARK --set-xmark 0x2/0xffffffff
COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -s 10.200.0.0/24 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -s 10.200.0.0/24 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -s 10.10.1.0/30 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -s 10.10.1.0/30 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i wg200 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -i wg200 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i wg200 -j ACCEPT
-A INPUT -p udp -m udp --dport 16200 -j ACCEPT
-A FORWARD ! -d 10.200.0.1/32 -i wg200 -p tcp -m tcp --dport 53 -j REJECT --reject-with tcp-reset
-A FORWARD ! -d 10.200.0.1/32 -i wg200 -p udp -m udp --dport 53 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -d 10.200.0.1/32 -i wg200 -p tcp -m tcp --dport 53 -j ACCEPT
-A FORWARD -d 10.200.0.1/32 -i wg200 -p udp -m udp --dport 53 -j ACCEPT
-A FORWARD -s 192.168.2.0/24 -o wg200 -j ACCEPT
-A FORWARD -s 192.168.1.0/24 -o wg200 -j ACCEPT
-A FORWARD -o wg200 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.200.0.0/24 -i wg200 -o eth0 -j ACCEPT
-A FORWARD -d 10.200.0.0/24 -i eth0 -o wg200 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg-ipsec -o eth0 -j ACCEPT
-A FORWARD -o wg200 -j ACCEPT
-A FORWARD -i wg-usa -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o wg-ipsec -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth0 -o wg-usa -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg200 -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o wg200 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg-home -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o wg-home -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg-dacha -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o wg-dacha -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg200 -o wg-home -j ACCEPT
-A FORWARD -i wg-home -o wg200 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg200 -o wg-dacha -j ACCEPT
-A FORWARD -i wg-dacha -o wg200 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.1.0/24 -o wg-ipsec -j ACCEPT
-A FORWARD -s 192.168.1.0/24 -o wg-usa -j ACCEPT
-A FORWARD -s 192.168.2.0/24 -o wg-ipsec -j ACCEPT
-A FORWARD -s 192.168.2.0/24 -o wg-usa -j ACCEPT
-A FORWARD -s 10.200.0.0/24 -o wg-ipsec -j ACCEPT
-A FORWARD -s 10.200.0.0/24 -o wg-usa -j ACCEPT
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wg200 -j ACCEPT
-A FORWARD -s 192.168.1.0/24 -j ACCEPT
-A FORWARD -s 192.168.2.0/24 -j ACCEPT
COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A OUTPUT -d 192.168.0.200/32 -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.1:53
-A OUTPUT -d 192.168.0.200/32 -p tcp -m tcp --dport 53 -j DNAT --to-destination 127.0.0.1:53
-A POSTROUTING -s 10.200.0.0/24 -d 192.168.2.0/24 -j RETURN
-A POSTROUTING -s 10.200.0.0/24 -d 192.168.1.0/24 -j RETURN
-A POSTROUTING -s 10.200.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -o eth0 -j MASQUERADE
-A POSTROUTING -o wg-ipsec -j MASQUERADE
-A POSTROUTING -o wg-usa -j MASQUERADE
COMMIT
