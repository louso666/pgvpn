#!/usr/bin/env bash

set -euo pipefail

# Проверяем аргументы
if [ $# -ne 1 ]; then
    echo 'Использование: /root/wg <имя_пользователя>'
    exit 1
fi

USERNAME=$1
WG_DIR=/etc/wireguard
INDEX_FILE=$WG_DIR/user_index.txt
# директория, где складируем клиентские конфиги
CLIENT_DIR=$WG_DIR/clients
SERVER_CONFIG=$WG_DIR/wg200.conf
SERVER_PUBLIC_KEY=$(cat $WG_DIR/server_public.key)

# Проверяем, что пользователь не существует
if [ -f "$CLIENT_DIR/$USERNAME.conf" ]; then
    exit 1
fi

# Готовим инфраструктуру для клиента
mkdir -p "$CLIENT_DIR"
[ -f "$INDEX_FILE" ] || echo 20 > "$INDEX_FILE"

# Читаем текущий индекс и увеличиваем его
USER_INDEX=$(cat $INDEX_FILE)
CLIENT_IP="10.200.0.$((USER_INDEX + 1))"
echo $((USER_INDEX + 1)) > $INDEX_FILE

# Генерируем ключи для клиента
cd $WG_DIR
CLIENT_PRIVATE_KEY=$(wg genkey)
CLIENT_PUBLIC_KEY=$(echo $CLIENT_PRIVATE_KEY | wg pubkey)
PRESHARED_KEY=$(wg genpsk)

# Добавляем пир в серверный конфиг
cat >> $SERVER_CONFIG << EOL

# $USERNAME
[Peer]
PublicKey = $CLIENT_PUBLIC_KEY
PresharedKey = $PRESHARED_KEY
AllowedIPs = $CLIENT_IP/32
EOL

# Создаем клиентский конфиг
cat > $CLIENT_DIR/$USERNAME.conf << EOL
# $USERNAME
[Interface]
PrivateKey = $CLIENT_PRIVATE_KEY
Address = $CLIENT_IP/32
ListenPort = 16200
DNS = 10.200.0.1
#PreUp = nping --udp --count 16 --data-length 16 --source-port 16200 --dest-port 16200 --delay 100ms 176.114.88.142

# pg.louso.ru
[Peer]
PublicKey = $SERVER_PUBLIC_KEY
PresharedKey = $PRESHARED_KEY
Endpoint = pg.louso.ru:16200
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 5
EOL

# Перезапускаем WireGuard
#wg-quick down wg200 2>/dev/null || true
#wg-quick up wg200
systemctl reload wg-quick@wg200

# Выводим клиентский конфиг
cat $CLIENT_DIR/$USERNAME.conf

echo ""
echo "Пользователь $USERNAME добавлен с IP $CLIENT_IP"
