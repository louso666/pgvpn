#!/bin/bash

# –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä HTML –ø—Ä–æ—Ñ–∏–ª–µ–π async-profiler

if [ $# -eq 0 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <html-—Ñ–∞–π–ª>"
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:"
    ls -1 profiling-results/*.html 2>/dev/null || echo "–§–∞–π–ª—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    exit 1
fi

HTML_FILE="$1"
if [ ! -f "$HTML_FILE" ]; then
    echo "–§–∞–π–ª $HTML_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è: $HTML_FILE"
echo "=============================================="

# –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML
echo "üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
grep -o 'Wall clock profile' "$HTML_FILE" && echo "–¢–∏–ø: Wall clock –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"

echo -e "\nüî• –¢–æ–ø –º–µ—Ç–æ–¥–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:"
echo "(–∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ HTML...)"

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
temp_file=$(mktemp)
grep -o 'f([^)]*' "$HTML_FILE" | head -20 > "$temp_file"

if [ -s "$temp_file" ]; then
    echo "–ù–∞–π–¥–µ–Ω–æ $(wc -l < "$temp_file") –∑–∞–ø–∏—Å–µ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ"
else
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
    echo "   firefox $HTML_FILE"
    echo "   –∏–ª–∏"
    echo "   google-chrome $HTML_FILE"
fi

rm "$temp_file"

echo -e "\nüìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ flame graph"
echo "2. –ò—â–∏—Ç–µ —à–∏—Ä–æ–∫–∏–µ –ø–æ–ª–æ—Å—ã –≤ flame graph - —ç—Ç–æ –º–µ—Ç–æ–¥—ã —Å –≤—ã—Å–æ–∫–∏–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º CPU"
echo "3. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –º–µ—Ç–æ–¥—ã IntelliJ:"
echo "   - com.intellij.codeInsight.*"
echo "   - com.github.copilot.*"
echo "   - jetbrains.exodus.*"

echo -e "\nüåê –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
echo "firefox $(realpath "$HTML_FILE")"

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
file_size=$(stat -c%s "$HTML_FILE")
if [ "$file_size" -gt 100000 ]; then
    echo -e "\n‚ö†Ô∏è  –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª –ø—Ä–æ—Ñ–∏–ª—è ($file_size –±–∞–π—Ç) - –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!"
fi

echo -e "\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω" 