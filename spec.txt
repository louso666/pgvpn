<<<<<<< HEAD
üìÑ –°—Ö–µ–º–∞ —Ç—É–Ω–Ω–µ–ª–µ–π –∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (—Å–µ–Ω—Ç—è–±—Ä—å 2025)
1. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

pg.louso.ru (–†–æ—Å—Å–∏—è, –æ—Å–Ω–æ–≤–Ω–æ–π —Ö–∞–±)
‚Ä¢ WireGuard wg200 ‚Üí 10.200.0.1/24 (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤)
‚Ä¢ WireGuard wg-ipsec ‚Üí 10.10.1.1/24 (–∫–∞–Ω–∞–ª –≤ –ï–≤—Ä–æ–ø—É / NL)
‚Ä¢ WireGuard wg-usa ‚Üí 10.10.2.1/24 (–∫–∞–Ω–∞–ª –≤ –ê–º–µ—Ä–∏–∫—É / USA)
‚Ä¢ dnsproxy (10.200.0.1:53) + Telegram-–±–æ—Ç
‚Ä¢ NAT –¥–ª—è 10.200.0.0/24 ‚Üí eth0 (SNAT/MASQ)
‚Ä¢ Policy-routing:
‚ñ∏ ipset nl_proxy ‚Üí MARK 0x1 ‚Üí table 101 ‚Üí default dev wg-ipsec
‚ñ∏ ipset usa_proxy ‚Üí MARK 0x2 ‚Üí table 102 ‚Üí default dev wg-usa
‚Ä¢ IPTables –∏ ipset –∫–æ–Ω—Ñ–∏–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ ipset-restore.service –∏ iptables-restore.service
‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö WG-–∫–æ–Ω—Ñ–∏–≥–æ–≤ —Å–∫—Ä–∏–ø—Ç–æ–º /root/wg (–±–æ—Ç –æ—Ç–¥–∞—ë—Ç –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)

ipsec.louso.ru (–ê–º—Å—Ç–µ—Ä–¥–∞–º, NL-—à–ª—é–∑)
‚Ä¢ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å WireGuard (peer wg-ipsec)
‚Ä¢ NAT/MASQUERADE –¥–ª—è –ø–æ–¥—Å–µ—Ç–µ–π –æ—Ç pg.louso.ru
‚Ä¢ iptables: —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ –º–∞—Å–∫–∞—Ä–∞–¥–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏–∑ —Ç—É–Ω–Ω–µ–ª—è ‚Üí eth0
‚Ä¢ MSS clamp –¥–ª—è TCP —á–µ—Ä–µ–∑ WG

usa.louso.ru (–ê–º–µ—Ä–∏–∫–∞, USA-—à–ª—é–∑)
‚Ä¢ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å WireGuard (peer wg-usa)
‚Ä¢ NAT/MASQUERADE –¥–ª—è –ø–æ–¥—Å–µ—Ç–µ–π –æ—Ç pg.louso.ru
‚Ä¢ iptables: —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ –º–∞—Å–∫–∞—Ä–∞–¥–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏–∑ —Ç—É–Ω–Ω–µ–ª—è ‚Üí eth0
‚Ä¢ MSS clamp –¥–ª—è TCP —á–µ—Ä–µ–∑ WG

2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º)

/root/site_nl –∏ /root/site_usa ‚Äî —Å–ø–∏—Å–∫–∏ –¥–æ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –±–æ—Ç–æ–º

/root/map.json ‚Äî –∏—Å—Ç–æ—Ä–∏—è —Ä–µ–∑–æ–ª–≤–æ–≤ (dnsproxy)

/etc/wireguard/* ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ + –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞ /root/wg

/etc/ipset.conf ‚Äî —Å–Ω–∏–º–æ–∫ ipset, –º–µ–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—Ç–∞–π–º–æ–º

3. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º)

/etc/iptables/** ‚Äî rules.v4/v6

/etc/systemd/system/*.service ‚Äî ipset-restore, policy-routing, wg-quick —é–Ω–∏—Ç—ã

–°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (pull-configs.sh, push-configs.sh –∏ —Ç. –¥.)

4. Watchdog‚Äô–∏ / –∞–≤—Ç–æ–ø–æ–¥—ä—ë–º

wg-quick@wg200.service ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤

wg-quick@wg-ipsec.service –∏ wg-quick@wg-usa.service ‚Äî –≤—ã—Ö–æ–¥–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–∏

ipset-restore.service ‚Äî –ø–æ–¥–Ω–∏–º–∞–µ—Ç ipset –Ω–∞ —Å—Ç–∞—Ä—Ç–µ

iptables-restore.service –∏–ª–∏ netfilter-persistent ‚Äî –ø–æ–¥–Ω–∏–º–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞

policy-routing.service ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç ip rule –∏ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è NL/USA

dnsproxy + –±–æ—Ç ‚Üí –≤ —Ä–∞–Ω—Ç–∞–π–º–µ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—é—Ç IP –ø–æ ipset –∏ –≤–µ–¥—É—Ç –ª–æ–≥–∏

5. –î–µ–ø–ª–æ–π

pull-configs.sh ‚Äî rsync –∫–æ–Ω—Ñ–∏–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –¥–∏–Ω–∞–º–∏–∫—É)

–ø—Ä–∞–≤–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤ git

push-configs.sh ‚Äî rsync –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã + iptables-restore –∏ —Ä–µ—Å—Ç–∞—Ä—Ç —é–Ω–∏—Ç–æ–≤
=======
üìÑ –°—Ö–µ–º–∞ —Ç—É–Ω–Ω–µ–ª–µ–π –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (—Å–µ–Ω—Ç—è–±—Ä—å 2025)

1. –£–∑–ª—ã
   ‚îú‚îÄ pg.louso.ru  (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä+DNS)
   ‚îÇ    ‚Ä¢ WireGuard: wg200 (–∫–ª–∏–µ–Ω—Ç—ã), wg-ipsec (–ª–∏–Ω–∫ –≤ NL), wg-usa (–ª–∏–Ω–∫ –≤ USA)
   ‚îÇ    ‚Ä¢ dnsproxy 10.200.0.1:53 + Telegram-–±–æ—Ç —É–ø—Ä–∞–≤–ª—è—é—Ç ipset –∏ wg –∫–ª–∏–µ–Ω—Ç–∞–º–∏
   ‚îÇ    ‚Ä¢ –ü–æ–ª–∏—Ç–∏–∫–∞: fwmark 0x1 (NL), 0x2 (USA) ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
   ‚îÇ    ‚Ä¢ NAT: 10.200.0.0/24 ‚Üí eth0, –∞ —Ç–∞–∫–∂–µ SNAT –Ω–∞ wg-ipsec/wg-usa
   ‚îú‚îÄ ipsec.louso.ru (VPS NL)
   ‚îÇ    ‚Ä¢ WireGuard wg-pg ‚áÑ pg.louso.ru, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç NL egress + VLESS
   ‚îî‚îÄ usa.louso.ru   (VPS USA)
        ‚Ä¢ WireGuard wg-pg ‚áÑ pg.louso.ru, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç US egress + VLESS

   –î–æ–º–∞—à–Ω–∏–π Mikrotik (192.168.1.0/24) –∏ –¥–∞—á–Ω—ã–π (192.168.2.0/24) –≤—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ wg200.

2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (–ò–°–ö–õ–Æ–ß–ê–ï–ú –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
   ‚Ä¢ /root/site_nl, /root/site_usa ‚Äì –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –ø–∏—à–µ—Ç –±–æ—Ç
   ‚Ä¢ /root/map.json             ‚Äì –∏—Å—Ç–æ—Ä–∏—è DNS‚ÜíIP, –ø–∏—à–µ—Ç dnsproxy
   ‚Ä¢ /etc/wireguard/clients/*   ‚Äì –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ wg200
   ‚Ä¢ /etc/wireguard/user_index.txt ‚Äì —Å—á—ë—Ç—á–∏–∫ IP, –≤–µ–¥—ë—Ç /root/wg
   ‚Ä¢ /etc/ipset.conf            ‚Äì –≤—ã–≥—Ä—É–∑–∫–∞ ipset save
   ‚Ä¢ /root/bot.db               ‚Äì SQLite –±–∞–∑–∞ –±–æ—Ç–∞/dnsproxy

3. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (–°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú)
   ‚Ä¢ /etc/iptables/rules.v4, ipsets ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∞ NL/USA + NAT
   ‚Ä¢ /etc/systemd/system: wg-quick@*.service (—á–µ—Ä–µ–∑ unit drop-in), proxy-route.service, wg-monitor.*,
     pgvpn.target, dnsproxy.service
   ‚Ä¢ /usr/local/bin/wg-monitor.sh, /root/wg (–±–æ—Ç–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–æ–≤)
   ‚Ä¢ WireGuard –ª–∏–Ω–∫–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏: wg200.conf, wg-ipsec.conf, wg-usa.conf, –∑–µ—Ä–∫–∞–ª—å–Ω—ã–µ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö VPS

4. Watchdog'–∏ / –∞–≤—Ç–æ–ø–æ–¥—ä—ë–º
   ‚Ä¢ wg-quick@wg{200,ipsec,usa}.service ‚Äì –∞–≤—Ç–æ–ø–æ–¥—ä—ë–º —Ç—É–Ω–Ω–µ–ª–µ–π
   ‚Ä¢ proxy-route.service ‚Äì –æ—Ñ–æ—Ä–º–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã 201/202 –∏ fwmark
   ‚Ä¢ wg-monitor.timer ‚Üí wg-monitor.service ‚Üí /usr/local/bin/wg-monitor.sh (—Ä–µ—Å—Ç–∞—Ä—Ç –∏ Telegram –æ–ø–æ–≤–µ—â–µ–Ω–∏—è)
   ‚Ä¢ pgvpn.target ‚Äì umbrella –¥–ª—è –≤—Å–µ–≥–æ —Å—Ç–µ–∫–∞
   ‚Ä¢ dnsproxy.service (Restart=always) ‚Äì —Å–ª–µ–¥–∏—Ç –∑–∞ ipset –∏ –±–æ—Ç–æ–º

5. –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è
   1) `scripts/pull-configs.sh <host>` ‚Äì —Å–Ω–∏–º–æ–∫ /etc –∏ /root (–±–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏)
   2) –ü—Ä–∞–≤–∫–∏ –≤ Git
   3) `scripts/push-configs.sh <host>` ‚Äì –≤—ã–∫–ª–∞–¥–∫–∞ (–±–µ–∑ --delete) + `systemctl daemon-reload`
   4) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: `dnsproxy/deploy.sh` –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –±–∏–Ω–∞—Ä—å –∏ –≤–∫–ª—é—á–∞–µ—Ç unit

6. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
   ‚Ä¢ scripts/pull-configs.sh    ‚Äì rsync ‚Üí –ª–æ–∫–∞–ª—å–Ω–æ; —Ä–µ–∂–µ—Ç *.backup/*.applied –∏ –ø—Ä.
   ‚Ä¢ scripts/push-configs.sh    ‚Äì rsync ‚Üê –Ω–∞ —Å–µ—Ä–≤–µ—Ä; –æ–±—â–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤
   ‚Ä¢ scripts/servers.conf       ‚Äì —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤/–ø–æ—Ä—Ç–æ–≤
   ‚Ä¢ pg.louso.ru/root/wg        ‚Äì –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ (–±–æ—Ç –¥–µ—Ä–≥–∞–µ—Ç `/wg <–∏–º—è>`)
   ‚Ä¢ pg.louso.ru/usr/local/bin/wg-monitor.sh ‚Äì –º–æ–Ω–∏—Ç–æ—Ä NL/USA –ª–∏–Ω–∫–æ–≤
>>>>>>> f9eaca5 (pg.louso: replace GRE path with WG policy stack)
